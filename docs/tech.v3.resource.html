<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tech.v3.resource documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XJYNJF48RM"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XJYNJF48RM');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">tech.resource</span> <span class="project-version">5.09</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="tech.v3.resource.html"><div class="inner"><span>tech.v3.resource</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tech.v3.resource.html#var-Bindable"><div class="inner"><span>Bindable</span></div></a></li><li class="depth-2"><a href="tech.v3.resource.html#var-execute-with-bound.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>execute-with-bound!</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-chain-resources"><div class="inner"><span>chain-resources</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-closeable.21"><div class="inner"><span>closeable!</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-in-stack-resource-context.3F"><div class="inner"><span>in-stack-resource-context?</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-releasing.21"><div class="inner"><span>releasing!</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-stack-resource-context"><div class="inner"><span>stack-resource-context</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-track"><div class="inner"><span>track</span></div></a></li><li class="depth-1"><a href="tech.v3.resource.html#var-with-bound.21"><div class="inner"><span>with-bound!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tech.v3.resource</h1><div class="doc"><div class="markdown"><p>System of calling functions with side effects when an object goes out of scope.  Scoping
can be defined as gc-based scoping or stack-based scoping or a combination of the two of them
in which case the behavior becomes 'release-no-later-than'.</p>
<p>For GC resources, users must not reference the tracked object in the dispose function
else the circular dependency will keep the object in the gc's live set</p>
</div></div><div class="public anchor" id="var-Bindable"><h3>Bindable</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-execute-with-bound.21"><h3>execute-with-bound!</h3><div class="usage"><code>(execute-with-bound! this ifn)</code></div><div class="doc"><div class="markdown"><p>Bind this object to be the current resource context and execute function.</p>
</div></div></div></div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L133">view source</a></div></div><div class="public anchor" id="var-chain-resources"><h3>chain-resources</h3><div class="usage"><code>(chain-resources new-resource old-resource)</code></div><div class="doc"><div class="markdown"><p>Chain an older resource to a newer (derived) one such that the older
resource cannot go out of gc scope before the newer resource has.  This
allows you to create 'sub' objects and ensure the parent object cannot get
cleaned up before 'sub' objects.</p>
<p>This is a very costly way of doing this and if misused it can lead to false
OOM situations.  The reason is that the link to the parent object is only broken
<em>after</em> the GC run so it takes as many gc runs as the depth of the object graph so
your code can easily create object graphs faster than it will cause gc runs.</p>
<p>Because of this it is much better to just have a member variable or metadata
that points back to the parent.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L115">view source</a></div></div><div class="public anchor" id="var-closeable.21"><h3>closeable!</h3><h4 class="type">macro</h4><div class="usage"><code>(closeable! &amp; body)</code></div><div class="doc"><div class="markdown"><p>Run code in a context and then return that context as a java.util.AutoCloseable.</p>
<p>Run more code in the current stack context by using <a href="tech.v3.resource.html#var-with-bound.21">with-bound!</a> - thus potentially
binding more objects to the current resource context.</p>
<p>All objects released tracked with this context bound with track-type :stack or :auto will
be released when the returned object is <code>close</code>d.  The returned object is derefable and
when derefed returns the return value of the code ran during its creation.</p>
<pre><code class="language-clojure">user&gt; (def res (resource/closeable! (let [v (atom 1)]
                                      (resource/track v {:dispose-fn #(swap! v dec)}))))
#'user/res
user&gt; @res
#&lt;Atom@34bc01ac: 1&gt;
user&gt; (resource/with-bound! res (let [v (atom 2)] (resource/track v {:dispose-fn #(swap! v inc)})))

#&lt;Atom@2d0f007c: 2&gt;
user&gt; (.close res)
nil
user&gt; *2
#&lt;Atom@2d0f007c: 3&gt;
user&gt; res
#&lt;resource$make_closeable_BANG_$reify__8490@48ce3240: #&lt;Atom@34bc01ac: 0&gt;&gt;
user&gt; (.close res)
nil
user&gt; (resource/with-bound! res (let [v (atom 2)] (resource/track v {:dispose-fn #(swap! v inc)})))

Execution error at tech.v3.resource$make_closeable_BANG_$reify$reify__8491/apply (form-init143758951282771418.clj:164).
Resources have been closed.
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L175">view source</a></div></div><div class="public anchor" id="var-in-stack-resource-context.3F"><h3>in-stack-resource-context?</h3><div class="usage"><code>(in-stack-resource-context?)</code></div><div class="doc"><div class="markdown"><p>Returns true if the current running code is inside a stack
resource context.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L39">view source</a></div></div><div class="public anchor" id="var-releasing.21"><h3>releasing!</h3><h4 class="type">macro</h4><div class="usage"><code>(releasing! &amp; body)</code></div><div class="doc"><div class="markdown"><p>Resources allocated within this stack frame will be released when
this code returns. Synonym for <a href="tech.v3.resource.html#var-stack-resource-context">stack-resource-context</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L108">view source</a></div></div><div class="public anchor" id="var-stack-resource-context"><h3>stack-resource-context</h3><h4 class="type">macro</h4><div class="usage"><code>(stack-resource-context &amp; body)</code></div><div class="doc"><div class="markdown"><p>Stack resource context.  When this context unwinds, stack resource declared within
will be released.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L101">view source</a></div></div><div class="public anchor" id="var-track"><h3>track</h3><div class="usage"><code>(track item {:keys [track-type dispose-fn]})</code><code>(track item)</code></div><div class="doc"><div class="markdown"><p>Track a resource.  If the item inherents from PResource or is a clojure fn, or a
Runnable object then it can be cleaned up by the stack system with no further dispose
function.  Objects tracked by the gc need to have a dispose fn that does <em>not</em>
reference the tracked object.</p>
<p>Using stack-based resource tracking when there is no stack resource context open
will generate a warning every time as it guarantees a memory leak.</p>
<p>Options:</p>
<ul>
<li>
<p><code>:track-type</code> - Track types can be :gc, :stack, <a href=":gc :stack">:gc :stack</a> or :auto with :auto being the default
tracking type.</p>
<ul>
<li><code>:gc</code> - Cleanup will be called just after the original object is garbage collected.</li>
<li><code>:stack</code> - Get cleaned up when the stack resource context is cleaned up.  This means a stack
returns context must be open.</li>
<li><code>:auto</code>: Will use stack if a stack is open and gc if one is not.</li>
</ul>
</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L60">view source</a></div></div><div class="public anchor" id="var-with-bound.21"><h3>with-bound!</h3><h4 class="type">macro</h4><div class="usage"><code>(with-bound! c &amp; body)</code></div><div class="doc"><div class="markdown"><p>Bind a closeable object as the current resource context.
Returns the return value of body.</p>
<p>See documentation for <a href="tech.v3.resource.html#var-closeable.21">closeable!</a>.</p>
</div></div><div class="src-link"><a href="https://github.com/cnuernber/charred/blob/master/src/tech/v3/resource.clj#L213">view source</a></div></div></div></body></html>